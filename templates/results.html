{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="my-2"><i class="fas fa-poll me-2"></i>Health Assessment Results</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center mb-4">
                            <div class="display-1 mb-2">
                                {% if prediction.outcome|lower == 'high' %}
                                <i class="fas fa-exclamation-triangle text-danger"></i>
                                {% elif prediction.outcome|lower == 'medium' %}
                                <i class="fas fa-exclamation-circle text-warning"></i>
                                {% else %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% endif %}
                            </div>
                            <h3 class="
                                {% if prediction.outcome|lower == 'high' %}text-danger
                                {% elif prediction.outcome|lower == 'medium' %}text-warning
                                {% else %}text-success{% endif %}
                            ">
                                {{ prediction.outcome|capitalize }} Risk
                            </h3>
                            <p class="lead">Risk Score: {{ prediction.risk_score }}</p>
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar 
                                    {% if prediction.outcome|lower == 'high' %}bg-danger
                                    {% elif prediction.outcome|lower == 'medium' %}bg-warning
                                    {% else %}bg-success{% endif %}" 
                                    role="progressbar" 
                                    style="width: {{ prediction.risk_score }}%;" 
                                    aria-valuenow="{{ prediction.risk_score }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                    {{ prediction.risk_score }}%
                                </div>
                            </div>
                            <p>Confidence: {{ prediction.probability }}%</p>
                        </div>
                        
                        <div class="mt-4">
                            <h4><i class="fas fa-comment-medical me-2"></i>Assessment Summary</h4>
                            <div class="card bg-dark">
                                <div class="card-body">
                                    {% if prediction.outcome|lower == 'high' %}
                                    <p>Your health metrics indicate a <strong>high risk</strong> of developing health issues. It's recommended to consult with a healthcare professional promptly.</p>
                                    <p>Focus on improving your modifiable risk factors and consider regular health check-ups.</p>
                                    {% elif prediction.outcome|lower == 'medium' %}
                                    <p>Your health metrics indicate a <strong>medium risk</strong> level. While not immediately concerning, there are areas that could be improved.</p>
                                    <p>Consider lifestyle modifications and regular health monitoring to reduce your risk factors.</p>
                                    {% else %}
                                    <p>Your health metrics indicate a <strong>low risk</strong> profile. You're on the right track with your health!</p>
                                    <p>Continue maintaining your healthy lifestyle and schedule regular preventive check-ups.</p>
                                    {% endif %}
                                    <p class="mb-0 font-italic text-muted">Note: This assessment is based on the information provided and should not replace professional medical advice.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4><i class="fas fa-chart-bar me-2"></i>Risk Factors Analysis</h4>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="featureImportanceChart"></canvas>
                        </div>
                        
                        <h4 class="mt-4"><i class="fas fa-clipboard-list me-2"></i>Your Input Data</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Your Value</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Age</td>
                                        <td>{{ user_input.age }}</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Gender</td>
                                        <td>{{ user_input.gender|capitalize }}</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Heart Rate</td>
                                        <td>{{ user_input.heart_rate }} bpm</td>
                                        <td>
                                            {% if user_input.heart_rate|int < 60 %}
                                            Below normal range
                                            {% elif user_input.heart_rate|int > 100 %}
                                            Above normal range
                                            {% else %}
                                            Normal range
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Blood Pressure</td>
                                        <td>{{ user_input.blood_pressure_systolic }}/{{ user_input.blood_pressure_diastolic }} mmHg</td>
                                        <td>
                                            {% if user_input.blood_pressure_systolic|int > 130 or user_input.blood_pressure_diastolic|int > 80 %}
                                            Higher than recommended
                                            {% else %}
                                            Normal range
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Cholesterol</td>
                                        <td>{{ user_input.cholesterol }} mg/dL</td>
                                        <td>
                                            {% if user_input.cholesterol|int > 200 %}
                                            Above desirable level
                                            {% else %}
                                            Desirable level
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Blood Sugar</td>
                                        <td>{{ user_input.blood_sugar }} mg/dL</td>
                                        <td>
                                            {% if user_input.blood_sugar|float > 100 %}
                                            Above normal range
                                            {% else %}
                                            Normal range
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>BMI</td>
                                        <td>{{ user_input.bmi }}</td>
                                        <td>
                                            {% if user_input.bmi|float < 18.5 %}
                                            Underweight
                                            {% elif user_input.bmi|float < 25 %}
                                            Normal weight
                                            {% elif user_input.bmi|float < 30 %}
                                            Overweight
                                            {% else %}
                                            Obese
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Smoking</td>
                                        <td>{{ user_input.smoking }}</td>
                                        <td>
                                            {% if user_input.smoking == 'yes' %}
                                            Consider quitting
                                            {% else %}
                                            Keep it up!
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Alcohol Consumption</td>
                                        <td>{{ user_input.alcohol_consumption }}</td>
                                        <td>
                                            {% if user_input.alcohol_consumption == 'yes' %}
                                            Moderate consumption recommended
                                            {% else %}
                                            Good choice!
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Physical Activity</td>
                                        <td>{{ user_input.physical_activity }} hours/week</td>
                                        <td>
                                            {% if user_input.physical_activity|int < 2.5 %}
                                            Below recommended level
                                            {% else %}
                                            Meets recommendations
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Family History</td>
                                        <td>{{ user_input.family_history }}</td>
                                        <td>
                                            {% if user_input.family_history == 'yes' %}
                                            Regular check-ups recommended
                                            {% else %}
                                            Lower genetic risk
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-redo me-2"></i>Start New Assessment
                    </a>
                    <button class="btn btn-info" id="printResults">
                        <i class="fas fa-print me-2"></i>Print Results
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart-config.js') }}"></script>
<script>
    // Feature importance data from the backend
    const featureImportance = {{ prediction.features_importance|tojson }};
    
    // Prepare data for chart
    const labels = Object.keys(featureImportance).map(key => {
        // Convert snake_case to readable format
        return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    });
    
    const data = Object.values(featureImportance);
    
    // Create chart
    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risk Factor Weight',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Relative Importance'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Weight: ${(context.raw * 100).toFixed(2)}%`;
                        }
                    }
                }
            }
        }
    });
    
    // Print functionality
    document.getElementById('printResults').addEventListener('click', function() {
        window.print();
    });
</script>
{% endblock %}
